#!/bin/sh
#*=====================================================================*/
#*    serrano/prgm/project/bigloo/bde/bmem/etc/bmemrun.in              */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Sun Apr 20 09:35:07 2003                          */
#*    Last change :  Thu Jan 26 08:12:20 2017 (serrano)                */
#*    Copyright   :  2003-17 Manuel Serrano                            */
#*    -------------------------------------------------------------    */
#*    The script shell to monitor memory allocations of Bigloo prgms   */
#*=====================================================================*/

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
safety=s
lib=
exe=a.out
bmon=

#*---------------------------------------------------------------------*/
#*    Argument parsing                                                 */
#*---------------------------------------------------------------------*/
while : ; do
  case $1 in
    "")
      break;;

    -h|--help)
      echo "bglmemrun: [options] exe [arg1] [arg2]..." >&2;
      echo "  -h|--help            -- This message" >&2;
      echo "  -s|-safe|--safe      -- Preload safe libraries" >&2;
      echo "  -u|-unsafe|--unsafe  -- Preload unsafe libraries" >&2;
      echo "  -t|--thread          -- Profile multithreaded program" >&2;
      echo "" >&2;
      echo "When running unsafe multithread programs use" >&2;
      echo "  -u -t, in that order" >&2;
      exit 0;;

    -s|-safe|--safe)
      safety=s;
      lib=<fildir>/bmem/bmem_$safety.so;;
    
    -u|-unsafe|--unsafe)
      safety=u;
      lib=<fildir>/bmem/bmem_$safety.so;;

    -t|--thread)
      lib=<fildir>/bmem/bmem_fth_$safety.so;;
    
    *)
      exe=$1;
      shift;
      args=$*;
      if [ "$bmon " = " " ]; then
        bmon="`echo $exe | sed 's/[.][^.]*$//'`.bmem";
        bmon=`basename $bmon`;
      fi;
      break;;

  esac
  shift
done


#*---------------------------------------------------------------------*/
#*    autoconfiguration                                                */
#*---------------------------------------------------------------------*/
if [ "$lib " = " " ]; then
  # safety
  g=`ldd $exe | grep libbigloo_u`
  if [ "$g " = " " ]; then
    safety=s
  else
    safety=u
  fi

  # gc
  g=`ldd $exe | grep libbigloogc_fth`
  if [ "$g " = " " ]; then
    gc=
  else
    gc=_fth
  fi
    
  lib=<fildir>/bmem/bmem"$gc"_"$safety".so
fi


#*---------------------------------------------------------------------*/
#*    Run the program                                                  */
#*---------------------------------------------------------------------*/
export BMEMUNSAFE=_$safety
LD_PRELOAD="$lib" $exe $args
