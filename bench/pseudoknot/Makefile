#*=====================================================================*/
#*    serrano/prgm/project/bigloo/bench/pseudoknot/Makefile            */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Tue Jan 30 15:19:19 1996                          */
#*    Last change :  Sun Jul  9 10:21:16 2017 (serrano)                */
#*    -------------------------------------------------------------    */
#*    The makefile to build pseudoknot                                 */
#*=====================================================================*/

#*---------------------------------------------------------------------*/
#*    Default configuration                                            */
#*---------------------------------------------------------------------*/
include ../../Makefile.buildconfig
include ../../Makefile.config

#*---------------------------------------------------------------------*/
#*    flags                                                            */
#*---------------------------------------------------------------------*/
BIGLOO		= $(BUILDBIGLOO)
BGLOPTFLAGS	= -Obench -q +rm
BFLAGS		= $(BGLOPTFLAGS)
LNFLAGS		= $(BGLOPTFLAGS) -static-bigloo
RUN		= ../run.sh
NBRUN		= 1
BENCH		= pseudoknot

#*---------------------------------------------------------------------*/
#*    Objects and sources                                              */
#*---------------------------------------------------------------------*/

#*--- scm -------------------------------------------------------------*/
SCM_FILE	= pseudoknot

SCM_OBJ		= $(SCM_FILE:%=%.o)
SCM_CLASS	= $(SCM_FILE:%=%.class)
SCM_SRC		= $(SCM_OBJ:%=%.scm)

#*---------------------------------------------------------------------*/
#*    All objects and sources                                          */
#*---------------------------------------------------------------------*/
OBJ		= $(C_OBJ) $(SCM_OBJ)
CLASS		= $(SCM_CLASS)
SRC		= $(C_SRC) $(SCM_SRC)

POPULATION	= $(SRC:%=bench/pseudoknot/%) bench/pseudoknot/Makefile

#*---------------------------------------------------------------------*/
#*    the goals.                                                       */
#*---------------------------------------------------------------------*/
$(BENCH): $(OBJ) 
	$(BIGLOO) $(LNFLAGS) $(OBJ) -o $(BENCH)

re-$(BENCH):
	@ $(MAKE) -s clean
	@ $(MAKE) -s $(BENCH)

pop:
	@ echo $(POPULATION)

clean:
	@ find . \( -name '*[~%]'                   \
                       -o -name '.??*[~%]'          \
                       -o -name '#*#'               \
                       -o -name '?*#'               \
                       -o -name \*core \)           \
                     -type f -exec rm {} \;   
	@- \rm -f $(COBJ)
	@- \rm -f $(JOBJ)
	@- \rm -f $(BENCH) 

#*---------------------------------------------------------------------*/
#*    Suffixes                                                         */
#*---------------------------------------------------------------------*/
.SUFFIXES:
.SUFFIXES: .scm .c .o

#*---------------------------------------------------------------------*/
#*    .c.o                                                             */
#*---------------------------------------------------------------------*/
.c.o:
	@ echo $*.c:
	@ $(CC) -c $(CFLAGS) $*.c -o $*.o

#*---------------------------------------------------------------------*/
#*    .scm.o                                                           */
#*---------------------------------------------------------------------*/
.scm.o:
	$(BIGLOO) -c $(BFLAGS) $*.scm -o $*.o

#*---------------------------------------------------------------------*/
#*    compile ...                                                      */
#*---------------------------------------------------------------------*/
.PHONY: compile
compile:
	@ echo "$(BENCH): "
	@ echo "  bigloo: $(BIGLOO)"
	@ echo "  bflags: $(LNFLAGS)"
	@ echo "  cflags: $(CFLAGS)"
	@ echo "  compilation:"
	@ echo "  - compiling $(BENCH)" 1>&2
	$(RUN) --bench=$(BENCH) --run=$(NBRUN) \
           "$(BIGLOO) $(BFLAGS) $(LNFLAGS) $(SCM_SRC) -o $(BENCH)"

#*---------------------------------------------------------------------*/
#*    run ...                                                          */
#*---------------------------------------------------------------------*/
.PHONY: run
run:
	@ echo "  execution:"
	@ echo "  - running $(BENCH)" 1>&2;
	$(RUN) --bench=$(BENCH) --run=$(NBRUN) "./$(BENCH)"
	@ $(MAKE) -s clean


